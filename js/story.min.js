function fcn_cleanUpActions(){_$$(".story__actions > *").forEach((t=>{const e=window.getComputedStyle(t);"none"!==e.display&&"hidden"!==e.visibility||t.remove()}))}application.register("fictioneer-story",class extends Stimulus.Controller{static get targets(){return["tabSection","tab","tabContent","commentsPlaceholder","commentsWrapper","commentsList","chapterGroup","filterReel","filterItem"]}static values={id:Number};commentPage=1;connect(){window.FictioneerApp.Controllers.fictioneerStory=this,this.#t(),this.hasFilterReelTarget&&"undefined"!=typeof Splide&&new Splide(this.filterReelTarget).mount()}toggleChapterOrder(){const t=this.#e();t.order="asc"===t.order?"desc":"asc",this.#s(t),this.#t()}toggleChapterView(){const t=this.#e();t.view="list"===t.view?"grid":"list",this.#s(t),this.#t()}unfoldChapters({currentTarget:t}){const e=t.closest(".chapter-group[data-folded]");e&&(e.dataset.folded="true"==e.dataset.folded?"false":"true")}toggleTab(t){const e=t.currentTarget;this.tabTargets.forEach((t=>{t.classList.remove("_current")})),this.tabContentTargets.forEach((e=>{e.dataset.tabName===t.params.tabName?e.classList.add("_current"):e.classList.remove("_current")})),this.tabSectionTarget.dataset.current=t.params.tabName,this.hasFilterItemTarget&&this.filterReelTarget.classList.toggle("hidden","chapters"!==t.params.tabName),e.classList.add("_current")}selectFilter({currentTarget:t,params:{groups:e,ids:s}}){const a=t.closest('[data-fictioneer-story-target="filterItem"]');this.hasFilterItemTarget&&this.hasChapterGroupTarget&&(this.filterItemTargets.forEach((t=>{t!=a&&t.classList.remove("selected")})),a.classList.toggle("selected"),this.#a(a,e?e.split(","):[],s?`${s}`.split(","):[]))}loadComments(t){this.hasIdValue&&this.hasCommentsListTarget&&(t.currentTarget.remove(),this.hasCommentsPlaceholderTarget&&this.commentsPlaceholderTarget.classList.remove("hidden"),FcnUtils.aGet({post_id:this.idValue,page:this.commentPage},"get_story_comments").then((t=>{this.hasCommentsPlaceholderTarget&&this.commentsPlaceholderTarget.remove(),t.success?(this.commentsListTarget.innerHTML+=t.data.html,this.commentPage++):t.data?.error&&this.commentsListTarget.appendChild(FcnUtils.buildErrorNotice(t.data.error))})).catch((t=>{this.hasCommentsPlaceholderTarget&&this.commentsPlaceholderTarget.remove(),this.commentsListTarget.appendChild(FcnUtils.buildErrorNotice(t))})))}startEpubDownload(t){t.preventDefault(),this.#r(t.currentTarget,0)}#a(t,e=[],s=[]){const a=_$$(".chapter-group__list-item");if(!t.classList.contains("selected"))return this.chapterGroupTargets.forEach((t=>t.classList.remove("filtered-in","filtered-out"))),void a.forEach((t=>t.classList.remove("filtered-in","filtered-out")));this.chapterGroupTargets.forEach((t=>t.classList.add("filtered-out"))),this.chapterGroupTargets.forEach((t=>t.classList.remove("filtered-in"))),s.length<1?a.forEach((t=>t.classList.remove("filtered-in","filtered-out"))):(a.forEach((t=>t.classList.add("filtered-out"))),a.forEach((t=>t.classList.remove("filtered-in")))),e.forEach((t=>{const e=_$$$(`chapter-group-${t}`);e&&(e.classList.remove("filtered-out"),e.classList.add("filtered-in"),s.length>0&&e.querySelectorAll(".filtered-out").forEach((t=>t.classList.remove("filtered-out"))),e.classList.contains("_closed")&&fcn().toggleChapterGroup({currentTarget:e}))})),s.length>0&&s.forEach((t=>{const s=_$(`[data-post-id="${t}"]`);if(!s)return;if(e.includes(s.dataset.group))return;s.classList.add("filtered-in"),s.classList.remove("filtered-out");const a=s.closest(".chapter-group");a&&!a.classList.contains("filtered-in")&&(a.classList.add("filtered-in"),a.classList.remove("filtered-out"),a.classList.contains("_closed")&&fcn().toggleChapterGroup({currentTarget:a}))}))}#e(){let t=FcnUtils.parseJSON(localStorage.getItem("fcnStorySettings"))??this.#i();return t.timestamp<1674770712849&&(t=this.#i(),t.timestamp=Date.now()),this.#s(t),t}#i(){return{view:"list",order:"asc",timestamp:1674770712849}}#s(t){"object"==typeof t&&localStorage.setItem("fcnStorySettings",JSON.stringify(t))}#t(){const t=this.#e();"object"==typeof t&&(_$$("[data-view]").forEach((e=>{e.dataset.view=t.view})),_$$("[data-order]").forEach((e=>{e.dataset.order=t.order})))}#r(t,e=0){!t.classList.contains("ajax-in-progress")&&this.hasIdValue&&(e>3?t.classList.remove("ajax-in-progress"):(t.classList.add("ajax-in-progress"),FcnUtils.aGet({action:"fictioneer_ajax_download_epub",story_id:this.idValue}).then((s=>{s.success?(window.location.href=t.href,setTimeout((()=>{t.classList.remove("ajax-in-progress")}),2e3)):setTimeout((()=>{fcn_startEpubDownload(t,e+1)}),2e3)})).catch((e=>{t.classList.remove("ajax-in-progress"),e.status&&e.statusText&&fcn_showNotification(`${e.status}: ${e.statusText}`,5,"warning")}))))}}),document.addEventListener("fcnUserDataReady",(()=>{fcn_cleanUpActions()}));